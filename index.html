<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitya AI Cloud</title>
    <style>
        :root { --bg: #0f0f0f; --panel: #1a1a1a; --accent: #00a2ff; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px 20px; background: var(--panel); display: flex; align-items: center; border-bottom: 1px solid #333; justify-content: space-between; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { padding: 12px 16px; border-radius: 15px; max-width: 80%; word-wrap: break-word; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .user { background: var(--accent); align-self: flex-end; border-bottom-right-radius: 2px; color: white; }
        .ai { background: #2d2d2d; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #444; }
        .input-area { padding: 20px; background: var(--panel); display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #0a0a0a; color: white; outline: none; }
        input:focus { border-color: var(--accent); }
        select { padding: 10px; border-radius: 10px; background: #0a0a0a; color: white; border: 1px solid #444; cursor: pointer; }
        button { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        button:disabled { background: #555; cursor: not-allowed; }
        .clear-btn { background: #ff4444; font-size: 12px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div id="header">
        <div style="display: flex; gap: 10px; align-items: center;">
            <strong>Mitya AI</strong>
            <select id="modelSelect">
                <option value="qwen3:8b">Qwen 3 (8B)</option>
                <option value="qwen2.5-coder:7b">Coder</option>
                <option value="gemma3:4b">Gemma 3</option>
            </select>
        </div>
        <button class="clear-btn" onclick="clearChat()">Очистить память</button>
    </div>

    <div id="chat"></div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Напиши что-нибудь своей нейронке...">
        <button id="sendBtn">Отправить</button>
    </div>

    <script>
        const TUNNEL_URL = 'https://mitya-ai.loca.lt';
        let chatHistory = []; // Тут хранится контекст

        async function sendMsg() {
            const input = document.getElementById('userInput');
            const chat = document.getElementById('chat');
            const btn = document.getElementById('sendBtn');
            const model = document.getElementById('modelSelect').value;

            if (!input.value || btn.disabled) return;

            const text = input.value;
            chat.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = '';
            btn.disabled = true;

            // Добавляем сообщение пользователя в историю
            chatHistory.push({ role: 'user', content: text });

            try {
                const response = await fetch(`${TUNNEL_URL}/api/chat`, { // Используем /api/chat для памяти
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model,
                        messages: chatHistory,
                        stream: false
                    })
                });

                const data = await response.json();
                const aiMsg = data.message.content;
                
                // Добавляем ответ ИИ в историю
                chatHistory.push({ role: 'assistant', content: aiMsg });
                
                chat.innerHTML += `<div class="msg ai">${aiMsg}</div>`;
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {
                chat.innerHTML += `<div class="msg ai" style="color:#ff6b6b">Ошибка связи! Проверь, запущен ли туннель на ПК.</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        function clearChat() {
            chatHistory = [];
            document.getElementById('chat').innerHTML = '<div class="msg ai" style="font-size: 0.8em; opacity: 0.6;">Память очищена.</div>';
        }

        document.getElementById('sendBtn').onclick = sendMsg;
        document.getElementById('userInput').onkeypress = (e) => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
